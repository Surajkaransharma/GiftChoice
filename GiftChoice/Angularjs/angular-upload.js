"use strict";angular.module("lr.upload",["lr.upload.formdata","lr.upload.iframe","lr.upload.directives"]),angular.module("lr.upload.directives",[]),angular.module("lr.upload.directives").directive("uploadButton",["upload",function(e){return{restrict:"EA",scope:{data:"=?data",url:"@",param:"@",method:"@",onUpload:"&",onSuccess:"&",onError:"&",onComplete:"&"},link:function(t,r,a){var o=angular.element(r),n=angular.element('<input type="file" />');if(o.append(n),n.on("change",function r(){var o=angular.element(this);if(!o[0].files||0!==o[0].files.length){var n={url:t.url,method:t.method||"POST",forceIFrameUpload:t.$eval(a.forceIframeUpload)||!1,data:t.data||{}};n.data[t.param||"file"]=o,t.$apply(function(){t.onUpload({files:o[0].files})}),e(n).then(function(e){t.onSuccess({response:e}),t.onComplete({response:e})},function(e){t.onError({response:e}),t.onComplete({response:e})})}}),"required"in a&&a.$observe("required",function e(a){var o=""===a||t.$eval(a);n.attr("required",o),r.toggleClass("ng-valid",!o),r.toggleClass("ng-invalid ng-invalid-required",o)}),"accept"in a&&a.$observe("accept",function e(t){n.attr("accept",t)}),e.support.formData){var i=function(){n.attr("multiple",!!(t.$eval(a.multiple)&&!t.$eval(a.forceIframeUpload)))};a.$observe("multiple",i),a.$observe("forceIframeUpload",i)}}}}]),angular.module("lr.upload.formdata",[]).factory("formDataTransform",function(){return function e(t){var r=new FormData;return angular.forEach(t,function(e,t){if(angular.isElement(e)){var a=[];angular.forEach(e,function(e){angular.forEach(e.files,function(e){a.push(e)}),e.value=""}),0!==a.length&&(a.length>1?angular.forEach(a,function(e,a){r.append(t+"["+a+"]",e)}):r.append(t,a[0]))}else r.append(t,e)}),r}}).factory("formDataUpload",["$http","formDataTransform",function(e,t){return function r(a){return a.transformRequest=t,a.method=a.method||"POST",a.headers=angular.extend(a.headers||{},{"Content-Type":void 0}),e(a)}}]),angular.module("lr.upload.iframe",[]).factory("iFrameUpload",["$q","$http","$document","$rootScope",function(e,t,r,a){return function o(n){var i=[],l=e.defer(),d=l.promise;angular.forEach(n.data||{},function(e,t){angular.isElement(e)&&(delete n.data[t],e.attr("name",t),i.push(e))});var u=/\?/.test(n.url)?"&":"?";"DELETE"===n.method?(n.url=n.url+u+"_method=DELETE",n.method="POST"):"PUT"===n.method?(n.url=n.url+u+"_method=PUT",n.method="POST"):"PATCH"===n.method&&(n.url=n.url+u+"_method=PATCH",n.method="POST");var f=angular.element(r[0].body),p=a.$new(),m="iframe-transport-"+p.$id;p.$destroy();var s=angular.element("<form></form>");s.attr("target",m),s.attr("action",n.url),s.attr("method",n.method||"POST"),s.css("display","none"),i.length&&(s.attr("enctype","multipart/form-data"),s.attr("encoding","multipart/form-data"));var c=angular.element('<iframe name="'+m+'" src="javascript:false;"></iframe>');return c.on("load",function(){function e(){var e=function e(t,r){if(t.indexOf)return t.indexOf(r);for(var a=0;a<t.length;a++)if(r===t[a])return a;return -1}(t.pendingRequests,n);-1!==e&&(t.pendingRequests.splice(e,1),n.$iframeTransportForm.remove(),delete n.$iframeTransportForm)}c.off("load").on("load",function(){try{var e,r,a,o,i=this.contentWindow?this.contentWindow.document:this.contentDocument;if(!(e=angular.element(i.body).text()).length)throw Error()}catch(d){}s.append(angular.element('<iframe src="javascript:false;"></iframe>'));try{e=(r=e,a=t.defaults.transformResponse,o=[],angular.isFunction(a)?a(r,o):(angular.forEach(a,function(e){r=e(r,o)}),r))}catch(u){}l.resolve({data:e,status:200,headers:[],config:n})}),angular.forEach(n.data,function(e,t){var r=angular.element('<input type="hidden" />');r.attr("name",t),r.val(e),s.append(r)}),angular.forEach(i,function(e){var t=e.clone(!0);e.after(t),s.append(e)}),n.$iframeTransportForm=s,t.pendingRequests.push(n),s[0].submit(),d.then(e,e)}),s.append(c),f.append(s),d}}]),angular.module("lr.upload").factory("upload",["$window","formDataUpload","iFrameUpload",function(e,t,r){var a={fileInput:!(RegExp("(Android (1\\.[0156]|2\\.[01]))|(Windows Phone (OS 7|8\\.0))|(XBLWP)|(ZuneWP)|(WPDesktop)|(w(eb)?OSBrowser)|(webOS)|(Kindle/(1\\.0|2\\.[05]|3\\.0))").test(e.navigator.userAgent)||angular.element('<input type="file">').prop("disabled")),fileUpload:!!(e.XMLHttpRequestUpload&&e.FileReader),formData:!!e.FormData};function o(e){return a.formData&&!e.forceIFrameUpload?t(e):r(e)}return o.support=a,o}]);